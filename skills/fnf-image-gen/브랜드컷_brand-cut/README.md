# 브랜드컷 (Brand Cut)

> 브랜드 화보 스타일 이미지 생성 - 얼굴 + 착장 + 컨셉 조합

---

## 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              브랜드컷 워크플로                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    입력      │     │    분석      │     │    생성      │     │    검증      │
│              │     │              │     │              │     │              │
│ 얼굴 이미지  │────>│ 착장 분석   │────>│ 프롬프트    │────>│ 5-Gate      │
│ 착장 이미지  │     │ (VLM)       │     │ 빌더        │     │ 순차 검사   │
│ 컨셉        │     │              │     │              │     │              │
└──────────────┘     └──────────────┘     └──────────────┘     └──────┬───────┘
                                                                       │
                                          ┌────────────────────────────┘
                                          │
                                          v
                           ┌─────────────────────────────┐
                           │     5개 Gate 모두 통과?      │
                           └─────────────────────────────┘
                                    │           │
                              예    │           │ 아니오
                                    v           v
                           ┌───────────┐  ┌───────────────┐
                           │  결과물   │  │ 재생성 (최대2)│
                           │  이미지   │  │ Gate별 강화   │
                           └───────────┘  └───────────────┘
```

---

## 데이터 플로우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               분석 단계                                      │
└─────────────────────────────────────────────────────────────────────────────┘

착장 이미지
     │
     └──> analyze_outfit() ──> 착장 분석 결과
               │
               ├── items: [
               │     {
               │       name: "바시티 점퍼",
               │       color: "네이비 + 화이트",
               │       logo: "NY 로고 (가슴)",
               │       details: ["레터링", "스냅버튼"],
               │       silhouette: "박시핏"
               │     },
               │     ...
               │   ]
               ├── layering_order: ["아우터", "이너", "하의"]
               └── style_vibe: "스트릿 캐주얼"


컨셉/레퍼런스
     │
     └──> analyze_concept() ──> 컨셉 분석 결과
               │
               ├── mood: "다이내믹, 에너지틱"
               ├── lighting: "하이키 자연광"
               ├── background: "도심 스트릿"
               └── pose_direction: "액티브 무브먼트"


┌─────────────────────────────────────────────────────────────────────────────┐
│                               생성 단계                                      │
└─────────────────────────────────────────────────────────────────────────────┘

분석 결과
     │
     └──> build_brandcut_prompt()
               │
               ├── 1. 브랜드 DNA (MLB/Discovery 등)
               ├── 2. 착장 설명 (착장 분석 결과)
               ├── 3. 모델 스펙 (얼굴, 체형)
               ├── 4. 컨셉/무드
               ├── 5. 포즈 & 구도
               ├── 6. 조명 & 배경
               └── 7. 품질 요구사항
                         │
                         v
               generate_brandcut()
                         │
                         ├── 얼굴 이미지 (API 직접 전달)
                         ├── 착장 이미지 (API 직접 전달)
                         └── 프롬프트 (텍스트)


┌─────────────────────────────────────────────────────────────────────────────┐
│                          검증 단계 (5-Gate)                                  │
└─────────────────────────────────────────────────────────────────────────────┘

생성 이미지 + 참조 이미지
     │
     └──> MLBValidator.validate()
               │
               │   ┌─────────────────────────────────────────┐
               │   │           순차 Gate 검사                 │
               │   │        (탈락 시 다음 Gate 안 봄)          │
               │   └─────────────────────────────────────────┘
               │
               ├──> Gate 1: 착장 검증 ────────────────────────>
               │         │
               │         ├── 모든 착장 아이템 존재?
               │         ├── 색상 일치?
               │         ├── 로고 위치/디자인 일치?
               │         └── 실루엣 일치?
               │                   │
               │             탈락? ──> 즉시 재생성 (착장 강화)
               │
               ├──> Gate 2: 얼굴 검증 ────────────────────────>
               │         │
               │         ├── 동일 인물?
               │         ├── 얼굴 비율 일치?
               │         └── 피부톤 일치?
               │                   │
               │             탈락? ──> 즉시 재생성 (얼굴 강화)
               │
               ├──> Gate 3: 포즈 검증 ────────────────────────>
               │         │
               │         ├── 관절 자연스러움?
               │         ├── 손가락 정상? (6개 이상 = 자동탈락)
               │         ├── 접지 자연스러움?
               │         └── 배경 호환성?
               │                   │
               │             탈락? ──> 즉시 재생성 (포즈 강화)
               │
               ├──> Gate 4: 브랜드 톤 검증 ───────────────────>
               │         │
               │         ├── 브랜드 라이브러리 준수?
               │         └── 금지 요소 위반?
               │                   │
               │             탈락? ──> 즉시 재생성 (톤 강화)
               │
               └──> Gate 5: 품질 마감 검증 ───────────────────>
                         │
                         ├── 해상도 충분?
                         ├── 아티팩트 없음?
                         └── AI 느낌 최소화?
                                   │
                         경고 0개 = 100점
                         경고 1개 = 98점
                         경고 2개 = 95점
                         경고 3개+ = 재생성
```

---

## 모듈 구조

```
core/brandcut/
├── __init__.py              # 통합 진입점
├── analyzer.py              # 착장 분석 (VLM)
├── generator.py             # 이미지 생성
├── prompt_builder.py        # 프롬프트 조립
├── korean_prompt_builder.py # 한국어 프롬프트
├── templates.py             # 프롬프트 템플릿
├── mlb_validator.py         # 5-Gate 검증기 (MLB 브랜드)
├── retry_generator.py       # Gate별 재시도 생성기
└── IMPLEMENTATION.md        # 구현 문서

skills/fnf-image-gen/브랜드컷_brand-cut/
├── README.md                # 이 문서
├── SKILL.md                 # Claude용 스킬 정의
└── mlb-prompt-cheatsheet.md # MLB 프롬프트 치트시트
```

---

## 핵심 원칙

### 1. 착장 분석 필수

```python
# 금지: 착장 분석 없이 바로 생성
images = generate_brandcut(prompt, faces, outfits)  # X

# 필수: 착장 분석 먼저
outfit_result = analyze_outfit(client, outfit_images)
prompt = build_prompt(outfit_analysis=outfit_result, ...)
images = generate_brandcut(prompt, faces, outfits)  # O
```

### 2. 이미지 전송 우선순위

| 순위 | 항목 | 전송 방식 |
|------|------|----------|
| 1 | 착장 이미지 | API 직접 전달 (전체!) |
| 2 | 얼굴 이미지 | API 직접 전달 |
| 3 | 컨셉/무드 | VLM 분석 → 텍스트 |
| 4 | 배경/조명 | VLM 분석 → 텍스트 |

### 3. 5-Gate 순차 검증

```
Gate 1 (착장) 탈락 → Gate 2~5 검사 안 함 → 착장 강화 재생성
Gate 2 (얼굴) 탈락 → Gate 3~5 검사 안 함 → 얼굴 강화 재생성
...
```

---

## 사용법

### Python API

```python
from core.brandcut import generate_with_validation, analyze_outfit

# 착장 분석
outfit_analysis = analyze_outfit(client, outfit_images)

# 생성 + 검증
result = generate_with_validation(
    prompt_json=prompt,
    face_images=face_imgs,
    outfit_images=outfit_imgs,
    api_key=api_key,
    max_retries=2,
)
```

### 결과 구조

```python
{
    "image": PIL.Image,
    "score": 95,
    "passed": True,
    "gate_results": {
        "outfit": {"score": 92, "passed": True},
        "face": {"score": 95, "passed": True},
        "pose": {"score": 88, "passed": True},
        "brand_tone": {"score": 90, "passed": True},
        "quality": {"score": 98, "passed": True},
    },
    "attempts": 1,
    "history": [...]
}
```

---

## 검증 기준 (5-Gate)

| Gate | 항목 | 탈락 조건 | 비교 대상 |
|------|------|----------|----------|
| 1 | 착장 | 누락/색상/로고/실루엣 불일치 | 착장 이미지 |
| 2 | 얼굴 | 다른 사람/비율/피부톤 불일치 | 얼굴 이미지 |
| 3 | 포즈 | 관절/손가락/접지/배경호환 어색 | 자체 판단 |
| 4 | 브랜드 톤 | 라이브러리 금지 요소 위반 | 프롬프트 라이브러리 |
| 5 | 품질 | 경고 3개 이상 | 자체 판단 |

**자동 탈락 조건:**
- 손가락 6개 이상
- 얼굴 완전히 다른 사람
- 착장 색상/로고 완전 불일치

---

## 브랜드별 프롬프트 라이브러리

| 브랜드 | 경로 | 상태 |
|--------|------|------|
| MLB | `prompt-library/mlb/` | 완료 |
| Discovery | `prompt-library/discovery/` | 예정 |
| Duvetica | `prompt-library/duvetica/` | 예정 |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 3.0.0 | 2026-02-12 | 모듈 분리 (core/brandcut/) |
| 2.0.0 | 2026-02-10 | 5-Gate 순차 검증 체계 |
| 1.0.0 | 2026-02-05 | 초기 버전 |
